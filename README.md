# TCP 서버 및 RabbitMQ 연동 프로그램

## 개요
이 프로그램은 **센서 데이터를 실시간으로 수신, 처리, 전송**하기 위해 설계된 TCP 서버입니다. 프로그램은 클라이언트로부터 센서 데이터를 수신한 뒤 데이터를 RabbitMQ 메시지 큐와 데이터베이스에 전달하며, 특정 클라이언트에게 스택에 저장된 데이터를 제공하는 기능도 포함하고 있습니다.

---

## 주요 기능
1. **TCP 서버**
   - 다중 클라이언트 연결을 처리할 수 있는 비동기 TCP 서버.
   - 센서 데이터를 수신하여 스택에 저장.
   - 특정 클라이언트(AI_HOST)에게 스택에 저장된 데이터를 전송.

2. **데이터 처리**
   - 센서 데이터를 지정된 바이너리 포맷(`SENSOR_DATA_FORMAT`)으로 파싱.
   - 파싱된 데이터를 RabbitMQ 큐와 데이터베이스에 적재.

3. **RabbitMQ 연동**
   - 센서 유형별로 RabbitMQ 큐를 동적으로 생성.
   - 센서 데이터를 JSON 형식으로 메시지로 구성하여 전송.

4. **스택 관리**
   - 스택의 최대 크기(`MAX_STACK_SIZE`)를 설정하여 오래된 데이터 제거.
   - 동시 접근을 제어하기 위해 비동기 락(`asyncio.Lock`) 사용.

---

## 프로그램 구성

### 1. **파일 구조**
- 이 코드는 단일 Python 파일로 작성되었으며, 비동기 및 메시지 큐 기반의 데이터 처리를 중심으로 동작합니다.

### 2. **주요 기술 스택**
- **Python**: 서버 및 비동기 데이터 처리를 위한 언어.
- **asyncio**: 비동기 네트워크 서버 구현.
- **RabbitMQ**: 메시지 큐를 활용한 데이터 전달.
- **pika**: RabbitMQ와의 통신을 위한 Python 라이브러리.
- **struct**: 센서 데이터 바이너리 포맷을 파싱하기 위한 라이브러리.

---

## 동작 원리

### 1. 클라이언트 연결
- 클라이언트가 TCP 서버에 연결하면, 프로그램은 클라이언트의 IP와 포트를 기록합니다.
- 클라이언트의 역할(AI_HOST인지 아닌지)에 따라 처리 방식이 달라집니다.

### 2. 데이터 수신 및 처리
- 클라이언트가 보낸 데이터를 지정된 크기(`SENSOR_DATA_SIZE`)만큼 읽습니다.
- 데이터를 파싱하여 JSON 형식의 메시지로 변환합니다.
- 각 센서 값은 RabbitMQ의 특정 큐(`vibration_x_queue`, `voltage_queue` 등)에 전송됩니다.

### 3. 데이터 스택 관리
- 수신한 데이터를 최대 크기가 설정된 스택에 저장하며, 오래된 데이터를 자동으로 제거합니다.
- 특정 클라이언트(AI_HOST)는 스택에서 데이터를 가져가 사용할 수 있습니다.

---

## 주요 설정

### TCP 서버
- **호스트**: `0.0.0.0` (모든 네트워크 인터페이스에서 수신)
- **포트**: `3000`

### RabbitMQ
- **호스트**: RABBITMQ_HOST 환경변수로 지정
- **인증 정보**: RABBITMQ_USER, RABBITMQ_PASSWORD 환경변수로 지정

### 데이터 포맷
- **바이너리 데이터 구조**: `'iiQ6f'`
  - `factory_id`: 정수형
  - `device_id`: 정수형
  - `timeStamp`: 정수형(UNIX 타임스탬프)
  - `vibration_x, vibration_y, vibration_z, voltage, rpm, temperature`: 부동소수점형(각 센서 데이터)

---